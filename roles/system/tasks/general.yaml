---

- name: Block for all hosts
  tags:
      - general
      - system
      - setup
  block:
    - name: Install required packages
      ansible.builtin.package:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - wget
          - gpg
          - coreutils
          - git
          - htop
          - sudo
          - nano
          - bash
          - unzip
          - figlet
          - golang
        state: present
        update_cache: yes

    - name: Generate /etc/hosts file
      ansible.builtin.template:
        src: "{{ role_path }}/templates/hosts.j2"
        dest: /etc/hosts

    - name: Block for OS-Specific updates
      when: ansible_os_family == "Debian"
      block:
        - name: Install unattended-upgrades
          ansible.builtin.package:
            name:
              - unattended-upgrades
            state: present

        - name: Run dist-upgrade
          ansible.builtin.apt:
            upgrade: dist
            update_cache: yes

        - name: Configure unattended-upgrades
          ansible.builtin.copy:
            src: "{{ role_path }}/files/{{ ansible_os_family }}-unattended-upgrades"
            dest: "{{ system.etc }}/apt/apt.conf.d/50unattended-upgrades"

      - name: Block for OS-Specific updates
        when: ansible_os_family == "FreeBSD"
        block:
          - name: Run freebsd-update (fetch)
            ansible.builtin.shell: freebsd-update fetch

          - name: Run freebsd-update (install)
            ansible.builtin.shell: freebsd-update install

          - name: Copy unattended-upgrade to server
            ansible.builtin.copy:
              src: "{{ role_path }}/files/{{ ansible_os_family }}-unattended-upgrades"
              dest: /usr/local/bin/unattended-upgrades
              owner: "{{ root.user }}"
              group: "{{ root.group }}"

          - name: Create crontab entry for upgrades
              ansible.builtin.cron:
                name: "Fetch and install updates"
                minute: "0"
                hour: "14"
                job: "/usr/local/bin/unattended-upgrades"
                mailto: "root"
                state: present