---

- name: Block for setting up caddy (OS-Family: Debian)
  tags:
    - debian
    - ubuntu
  when: ansible_os_family =0 "Debian"
  block:
    - name: Add the Caddy repository key
      ansible.builtin.apt_key:
        url: https://dl.cloudsmith.io/public/caddy/stable/gpg.key
        state: present

    - name: Add the Caddy APT repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://dl.cloudsmith.io/public/caddy/stable/deb/ubuntu focal main"
        state: present
        filename: caddy-stable


- name: Block for all OS-Families
  block:
    - name: Install caddy
      ansible.builtin.package:
        name: 
          - caddy
        update_cache: yes

    - name: Generate Caddyfile
      ansible.builtin.template:
        src: "{{ role_path }}/templates/Caddyfile.j2"
        dest: "{{ system.etc }}/caddy/Caddyfile"
        owner: "{{ root.user }}"
        group: "{{ root.group }}"
      notify: Restart caddy
      vars:
        webtunnel_path: "{{ lookup('file', role_path + '/files/' + inventory_hostname + '.txt') }}"