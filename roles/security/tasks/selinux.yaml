---

- name: Install required packages
  ansible.builtin.package:
    name:
      - "{{ item }}"
    state: present
  loop: security.packages

- name: Enable SELinux
  ansible.builtin.lineinfile:
    path: "{{ system.etc }}/selinux/config"
    regexp: '^SELINUX='
    line: 'SELINUX=enforcing'
    create: yes

- name: Set SELinux to Enforcing Mode
  ansible.builtin.shell: 
    cmd: setenforce 1
  ignore_errors: yes
  notify: Restart system

- name: Set SELinux context for Tor data directory
  community.general.sefcontext:
    target: "{{ tor.directory }}(/.*)?"
    setype: tor_var_lib_t
    state: present

- name: Set SELinux context for Tor configuration files
  community.general.sefcontext:
    target: "{{ system.etc }}/tor(/.*)?"
    setype: tor_etc_t
    state: present

- name: Set SELinux context for Tor logs
  community.general.sefcontext:
    target: "/var/log/tor(/.*)?"
    setype: tor_log_t
    state: present

- name: Apply SELinux file context changes for Tor
  ansible.builtin.shell:
    cmd: restorecon -Rv {{ tor.directory }} {{ system.etc }}/tor
  notify: Restart system

- name: Set SELinux context for WebTunnel binary
  community.general.sefcontext:
    target: "/usr/local/bin/webtunnel"
    setype: tor_exec_t
    state: present

- name: Allow WebTunnel binary to execute
  ansible.builtin.shell:
    cmd: restorecon -Rv /usr/local/bin/webtunnel
  notify: Restart system

- name: Allow Tor to bind to WebTunnel port 15000
  ansible.builtin.shell:
    cmd: semanage port -a -t tor_port_t -p tcp 15000
  ignore_errors: yes

- name: Allow Tor to communicate with web servers
  ansible.builtin.shell:
    cmd: setsebool -P httpd_can_network_connect 1
  notify: Restart system

- name: Set SELinux context for Web Server Reverse Proxy Directories
  community.general.sefcontext:
    target: "/var/www/html(/.*)?"
    setype: httpd_sys_rw_content_t
    state: present

- name: Allow Web Server to Connect to Tor WebTunnel
  ansible.builtin.shell:
    cmd: setsebool -P httpd_can_network_relay 1
  notify: Restart system

- name: Apply SELinux file context changes for Web Servers
  ansible.builtin.shell:
    cmd: restorecon -Rv /var/www/html {{ system.etc }}/{{ use_webserver }}
  notify: Restart system
