name: Test Ansible Playbook by Server

on:
  push:
    branches-ignore:
      - main

env:
  ANSIBLE_USER_PASSWORD: ${{ secrets.ANSIBLE_USER_PASSWORD }}

jobs:
  setup-ansible-on-runner:
    runs-on: self-hosted
    steps:
      - name: Install apt packages
        run: |
          sudo setup-ansible

      - name: Install pip reqiurements
        run: |
          pip install -r requirements.txt

      - name: Install ansible-galaxy requirements
        run: |
          ansible-galaxy install -r requirements.yaml

  initialise-run-counter:
    runs-on: self-hosted
    steps:
      - name: Download run counter
        id: download-counter
        uses: actions/download-artifact@v4
        with:
          name: run-counter
          path: .github/workflows/

      - name: Read counter
        id: read-counter
        run: |
          if [ -f .github/workflows/counter.txt ]; then
            RUN_COUNT=$(cat .github/workflows/counter.txt)
          else
            RUN_COUNT=0
          fi
          echo "RUN_COUNT=$RUN_COUNT" >> $GITHUB_ENV

      - name: Determine webserver
        id: select-webserver
        run: |
          WEBSERVERS=("caddy" "nginx" "apache")
          INDEX=$((RUN_COUNT % 3))
          WEBSERVER_SOFTWARE=${WEBSERVERS[$INDEX]}
          echo "WEBSERVER_SOFTWARE=$WEBSERVER_SOFTWARE" >> $GITHUB_ENV
          echo "Using webserver: $WEBSERVER_SOFTWARE"

  setup-ubuntu:
    needs:
      - setup-ansible-on-runner
      - initialise-run-counter
    runs-on: self-hosted
    env:
      OS: ubuntu
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      #- name: Delete ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }}
      #  run: |
      #    echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
      #    ansible-playbook actions-playbook.yaml --tags=delete-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Create ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }} server
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=create-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Start all ${ env.OS }} servers
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=start-server -e 'os=os=${{ env.OS }}'

      - name: Wait until the ${{ env.OS }} servers are reachable
        run: |
          python3 scripts/check_hosts.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Run Ansible Playbook Test for ${{ env.OS }}
        run: |
          ansible-playbook playbook.yaml --limit=${{ env.OS }} -i actions-inventory.ini

      - name: Upload connection-strings for ${{ env.OS }}
        uses: actions/upload-artifact@v4
        with:
          name: connection-strings-${{ env.OS }}
          path: connection-strings.txt

  test-ubuntu:
    needs: 
      - setup-ubuntu
    runs-on: self-hosted
    env:
      OS: ubuntu
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create ${{ env.OS }} webtunnel-client
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=create-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: connection-strings-${{ env.OS }}

      - name: Wait until the ${{ env.OS }} servers are reacheable
        run: |
          python3 scripts/check_hosts.py --limit=${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test connections
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=test-webtunnel --limit=${{ env.OS }}-webtunnel-client -i actions-inventory.ini 

      - name: Shutdown ${{ env.OS }} servers
        run: |
          ansible-playbook playbook.yaml --tags=shutdown-server --limit=${{ env.OS }} -i actions-inventory.ini

      - name: Delete ${{ env.OS }} webtunnel-client
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=delete-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

  setup-alpine:
    needs:
      - setup-ansible-on-runner
      - initialise-run-counter
    runs-on: self-hosted
    env:
      OS: alpine
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      #- name: Delete ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }}
      #  run: |
      #    echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
      #    ansible-playbook actions-playbook.yaml --tags=delete-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Create ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }} server
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=create-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Start all ${ env.OS }} servers
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=start-server -e 'os=os=${{ env.OS }}'


      - name: Wait until the ${{ env.OS }} servers are reachable
        run: |
          python3 scripts/check_hosts.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Run Ansible Playbook Test for ${{ env.OS }}
        run: |
          ansible-playbook playbook.yaml --limit=${{ env.OS }} -i actions-inventory.ini

      - name: Upload connection-strings for ${{ env.OS }}
        uses: actions/upload-artifact@v4
        with:
          name: connection-strings-${{ env.OS }}
          path: connection-strings.txt

  test-alpine:
    needs: 
      - setup-alpine
    runs-on: self-hosted
    env:
      OS: alpine
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create ${{ env.OS }} webtunnel-client
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=create-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: connection-strings-${{ env.OS }}

      - name: Wait until the ${{ env.OS }} servers are reacheable
        run: |
          python3 scripts/check_hosts.py --limit=${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test connections
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=test-webtunnel --limit=${{ env.OS }}-webtunnel-client -i actions-inventory.ini 

      - name: Shutdown ${{ env.OS }} servers
        run: |
          ansible-playbook playbook.yaml --tags=shutdown-server --limit=${{ env.OS }} -i actions-inventory.ini

      - name: Delete ${{ env.OS }} webtunnel-client
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=delete-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

  setup-archlinux:
    needs:
      - setup-ansible-on-runner
      - initialise-run-counter
    runs-on: self-hosted
    env:
      OS: archlinux
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      #- name: Delete ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }}
      #  run: |
      #    echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
      #    ansible-playbook actions-playbook.yaml --tags=delete-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Create ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }} server
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=create-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Start all ${ env.OS }} servers
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=start-server -e 'os=os=${{ env.OS }}'


      - name: Wait until the ${{ env.OS }} servers are reachable
        run: |
          python3 scripts/check_hosts.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Run Ansible Playbook Test for ${{ env.OS }}
        run: |
          ansible-playbook playbook.yaml --limit=${{ env.OS }} -i actions-inventory.ini

      - name: Upload connection-strings for ${{ env.OS }}
        uses: actions/upload-artifact@v4
        with:
          name: connection-strings-${{ env.OS }}
          path: connection-strings.txt

  test-archlinux:
    needs: 
      - setup-archlinux
    runs-on: self-hosted
    env:
      OS: archlinux
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create ${{ env.OS }} webtunnel-client
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=create-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: connection-strings-${{ env.OS }}

      - name: Wait until the ${{ env.OS }} servers are reacheable
        run: |
          python3 scripts/check_hosts.py --limit=${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test connections
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=test-webtunnel --limit=${{ env.OS }}-webtunnel-client -i actions-inventory.ini 

      - name: Shutdown ${{ env.OS }} servers
        run: |
          ansible-playbook playbook.yaml --tags=shutdown-server --limit=${{ env.OS }} -i actions-inventory.ini

      - name: Delete ${{ env.OS }} webtunnel-client
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=delete-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

  setup-freebsd:
    needs:
      - setup-ansible-on-runner
      - initialise-run-counter
    runs-on: self-hosted
    env:
      OS: freebsd
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      #- name: Delete ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }}
      #  run: |
      #    echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
      #    ansible-playbook actions-playbook.yaml --tags=delete-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Create ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }} server
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=create-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Start all ${ env.OS }} servers
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=start-server -e 'os=os=${{ env.OS }}'


      - name: Wait until the ${{ env.OS }} servers are reachable
        run: |
          python3 scripts/check_hosts.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Run Ansible Playbook Test for ${{ env.OS }}
        run: |
          ansible-playbook playbook.yaml --limit=${{ env.OS }} -i actions-inventory.ini

      - name: Upload connection-strings for ${{ env.OS }}
        uses: actions/upload-artifact@v4
        with:
          name: connection-strings-${{ env.OS }}
          path: connection-strings.txt

  test-freebsd:
    needs: 
      - setup-freebsd
    runs-on: self-hosted
    env:
      OS: freebsd
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create ${{ env.OS }} webtunnel-client
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=create-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: connection-strings-${{ env.OS }}

      - name: Wait until the ${{ env.OS }} servers are reacheable
        run: |
          python3 scripts/check_hosts.py --limit=${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test connections
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=test-webtunnel --limit=${{ env.OS }}-webtunnel-client -i actions-inventory.ini 

      - name: Shutdown ${{ env.OS }} servers
        run: |
          ansible-playbook playbook.yaml --tags=shutdown-server --limit=${{ env.OS }} -i actions-inventory.ini

      - name: Delete ${{ env.OS }} webtunnel-client
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=delete-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

  setup-openbsd:
    needs:
      - setup-ansible-on-runner
      - initialise-run-counter
    runs-on: self-hosted
    env:
      OS: openbsd
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      #- name: Delete ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }}
      #  run: |
      #    echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
      #    ansible-playbook actions-playbook.yaml --tags=delete-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Create ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }} server
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=create-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Start all ${ env.OS }} servers
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=start-server -e 'os=os=${{ env.OS }}'


      - name: Wait until the ${{ env.OS }} servers are reachable
        run: |
          python3 scripts/check_hosts.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Run Ansible Playbook Test for ${{ env.OS }}
        run: |
          ansible-playbook playbook.yaml --limit=${{ env.OS }} -i actions-inventory.ini

      - name: Upload connection-strings for ${{ env.OS }}
        uses: actions/upload-artifact@v4
        with:
          name: connection-strings-${{ env.OS }}
          path: connection-strings.txt

  test-openbsd:
    needs: 
      - setup-openbsd
    runs-on: self-hosted
    env:
      OS: openbsd
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create ${{ env.OS }} webtunnel-client
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=create-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: connection-strings-${{ env.OS }}

      - name: Wait until the ${{ env.OS }} servers are reacheable
        run: |
          python3 scripts/check_hosts.py --limit=${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test connections
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=test-webtunnel --limit=${{ env.OS }}-webtunnel-client -i actions-inventory.ini 

      - name: Shutdown ${{ env.OS }} servers
        run: |
          ansible-playbook playbook.yaml --tags=shutdown-server --limit=${{ env.OS }} -i actions-inventory.ini

      - name: Delete ${{ env.OS }} webtunnel-client
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=delete-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

  setup-rhel:
    needs:
      - setup-ansible-on-runner
      - initialise-run-counter
    runs-on: self-hosted
    env:
      OS: rhel
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      #- name: Delete ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }}
      #  run: |
      #    echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
      #    ansible-playbook actions-playbook.yaml --tags=delete-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Create ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }} server
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=create-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Start all ${ env.OS }} servers
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=start-server -e 'os=os=${{ env.OS }}'


      - name: Wait until the ${{ env.OS }} servers are reachable
        run: |
          python3 scripts/check_hosts.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Run Ansible Playbook Test for ${{ env.OS }}
        run: |
          ansible-playbook playbook.yaml --limit=${{ env.OS }} -i actions-inventory.ini

      - name: Upload connection-strings for ${{ env.OS }}
        uses: actions/upload-artifact@v4
        with:
          name: connection-strings-${{ env.OS }}
          path: connection-strings.txt

  test-rhel:
    needs: 
      - setup-rhel
    runs-on: self-hosted
    env:
      OS: rhel
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create ${{ env.OS }} webtunnel-client
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=create-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: connection-strings-${{ env.OS }}

      - name: Wait until the ${{ env.OS }} servers are reacheable
        run: |
          python3 scripts/check_hosts.py --limit=${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test connections
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=test-webtunnel --limit=${{ env.OS }}-webtunnel-client -i actions-inventory.ini 

      - name: Shutdown ${{ env.OS }} servers
        run: |
          ansible-playbook playbook.yaml --tags=shutdown-server --limit=${{ env.OS }} -i actions-inventory.ini

      - name: Delete ${{ env.OS }} webtunnel-client
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=delete-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

  setup-suse:
    needs:
      - setup-ansible-on-runner
      - initialise-run-counter
    runs-on: self-hosted
    env:
      OS: suse
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      #- name: Delete ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }}
      #  run: |
      #    echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
      #    ansible-playbook actions-playbook.yaml --tags=delete-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Create ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }} server
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=create-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Start all ${ env.OS }} servers
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=start-server -e 'os=os=${{ env.OS }}'


      - name: Wait until the ${{ env.OS }} servers are reachable
        run: |
          python3 scripts/check_hosts.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Run Ansible Playbook Test for ${{ env.OS }}
        run: |
          ansible-playbook playbook.yaml --limit=${{ env.OS }} -i actions-inventory.ini

      - name: Upload connection-strings for ${{ env.OS }}
        uses: actions/upload-artifact@v4
        with:
          name: connection-strings-${{ env.OS }}
          path: connection-strings.txt

  test-suse:
    needs: 
      - setup-suse
    runs-on: self-hosted
    env:
      OS: suse
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create ${{ env.OS }} webtunnel-client
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=create-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: connection-strings-${{ env.OS }}

      - name: Wait until the ${{ env.OS }} servers are reacheable
        run: |
          python3 scripts/check_hosts.py --limit=${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test connections
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=test-webtunnel --limit=${{ env.OS }}-webtunnel-client -i actions-inventory.ini 

      - name: Shutdown ${{ env.OS }} servers
        run: |
          ansible-playbook playbook.yaml --tags=shutdown-server --limit=${{ env.OS }} -i actions-inventory.ini

      - name: Delete ${{ env.OS }} webtunnel-client
        run: |
          echo -e "\nANSIBLE_USER_PASSWORD=$ANSIBLE_USER_PASSWORD" >> .env
          ansible-playbook actions-playbook.yaml --tags=delete-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

  increase-run-counter:
    needs:
      - setup-ubuntu
      - setup-alpine
      - setup-archlinux
      - setup-freebsd
      - setup-openbsd
      - setup-rhel
      - setup-suse
    if: always()
    runs-on: self-hosted
    steps:
      - name: Increment and save counter
        run: |
          echo $((RUN_COUNT + 1)) > .github/workflows/counter.txt

      - name: Upload updated counter
        uses: actions/upload-artifact@v4
        with:
          name: run-counter
          path: .github/workflows/counter.txt
          overwrite: true