---

name: Test Ansible Playbook

on:
  workflow_dispatch:
#  push:
#    branches-ignore:
#      - main
#    paths-ignore:
#      - '.github/workflows/venv.yml'
#      - '.github/workflows/hostvars.yml'
#      - '.github/ISSUE_TEMPLATE/*'
#      - '.github/CODEOWNERS'
#      - 'requirements.txt'
#      - 'requirements.yaml'
#      - 'todo.md'
#      - 'readme.md'
#      - '.env'
#      - '.yamllint'
#      - '.ansible-lint'
#      - '.pre-commit-config.yaml'
#      - '.gitignore'
#  pull_request:
#    branches:
#      - main

env:
  PY_COLORS: 1
  ANSIBLE_FORCE_COLOR: 1
  TEST_SERVER_TLD: ${{ secrets.TEST_SERVER_TLD }}

jobs:
  create-test-servers:
    runs-on: self-hosted
    container:
      image: homebrew/brew:master
    env:
      HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
    steps:
      - name: Install OpenTofu
        run: brew install opentofu

      - name: Init Tofu Project
        run: |
          cd .tests/infra
          tofu init

      - name: Create Test-Infrastructure
        run: tofu apply --auto-approve
