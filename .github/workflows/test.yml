name: Test Ansible Playbook

on:
  push:
    branches-ignore:
      - main

env:
  ANSIBLE_USER_PASSWORD: ${{ secrets.ANSIBLE_USER_PASSWORD }}
  PY_COLORS: 1
  ANSIBLE_FORCE_COLOR: 1

jobs:
  generate-host-vars:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to S3
        uses: mc-actions/configure@v1
        with:
          s3_server: '${{ secrets.S3_ENDPOINT }}'
          s3_access_key: '${{ secrets.S3_ACCESS_KEY }}'
          s3_secret_key: '${{ secrets.S3_SECRET_KEY }}'
    
      - name: Download venv from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/venv/ venv/ >/dev/null && \
          echo "Downloaded venv successfully. Changing permissions now."
          chmod +x venv/bin/*

      - name: Generate host_vars/os-webserver.yaml
        run: |
          source venv/bin/activate
          python3 scripts/generate_host_vars.py

      - name: Upload test_host_vars to S3
        shell: bash
        run: |
          mc cp -r test_host_vars/ default/actions-artifacts/test_host_vars/

  select-webserver:
    runs-on: self-hosted
    outputs:
      webserver: ${{ steps.select-webserver.outputs.webserver }}
    steps:
      - name: Determine webserver randomly
        id: select-webserver
        run: |
          WEBSERVERS=("caddy" "nginx" "apache")
          RANDOM_INDEX=$((RANDOM % 3))
          WEBSERVER_SOFTWARE=${WEBSERVERS[$RANDOM_INDEX]}
          echo "webserver=$WEBSERVER_SOFTWARE" >> "$GITHUB_OUTPUT"
          echo "Using webserver: $WEBSERVER_SOFTWARE"

  setup-ubuntu:
    needs:
      - generate-host-vars
      - select-webserver
    runs-on: self-hosted
    env:
      OS: ubuntu
      WEBSERVER_SOFTWARE: ${{ needs.select-webserver.outputs.webserver }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to S3
        uses: mc-actions/configure@v1
        with:
          s3_server: '${{ secrets.S3_ENDPOINT }}'
          s3_access_key: '${{ secrets.S3_ACCESS_KEY }}'
          s3_secret_key: '${{ secrets.S3_SECRET_KEY }}'

      - name: Download host_vars from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/test_host_vars/ host_vars/ >/dev/null && \
          echo "Downloaded test_host_vars successfully.

      - name: Download venv from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/venv/ venv/ >/dev/null && \
          echo "Downloaded venv successfully. Changing permissions now."
          chmod +x venv/bin/*

      - name: Delete ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }}
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=delete-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Create ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }} server
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=create-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Start all ${{ env.OS }} servers
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=start-server -i actions-inventory.ini -e 'os=${{ env.OS }}'

      - name: Wait until the ${{ env.OS }} servers are reachable
        run: |
          source venv/bin/activate
          python3 scripts/check_hosts.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Run Ansible Playbook Test for ${{ env.OS }}
        run: |
          source venv/bin/activate
          ansible-playbook playbook.yaml --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Upload connection-strings for ${{ env.OS }} to S3
        shell: bash
        run: |
          mc cp connection-strings.txt default/actions-artifacts/connection-strings-${{ env.OS }}

  test-ubuntu:
    needs: 
      - setup-ubuntu
    runs-on: self-hosted
    env:
      OS: ubuntu
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to S3
        uses: mc-actions/configure@v1
        with:
          s3_server: '${{ secrets.S3_ENDPOINT }}'
          s3_access_key: '${{ secrets.S3_ACCESS_KEY }}'
          s3_secret_key: '${{ secrets.S3_SECRET_KEY }}'

      - name: Download host_vars from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/test_host_vars/ host_vars/ >/dev/null && \
          echo "Downloaded test_host_vars successfully.

      - name: Download venv from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/venv/ venv/ >/dev/null && \
          echo "Downloaded venv successfully. Changing permissions now."
          chmod +x venv/bin/*

      - name: Create ${{ env.OS }} webtunnel-client
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=create-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

      - name: Download connection-strings-${{ env.OS }} from S3
        shell: bash
        run: |
          mc cp default/actions-artifacts/connection-strings-${{ env.OS }} connection-strings.txt

      - name: Wait until the ${{ env.OS }} webtunnel client is reacheable
        run: |
          source venv/bin/activate
          python3 scripts/check_hosts.py --limit ${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test connections
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=test-webtunnel --limit ${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test SSH connection
        run: |
          source venv/bin/activate
          python3 scripts/test_ssh.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Test HTTP/HTTPS connection
        run: |
          source venv/bin/activate
          python3 scripts/test_web.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Shutdown ${{ env.OS }} servers
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=shutdown-server -i actions-inventory.ini  -e "os=${{ env.OS }}"

      - name: Delete ${{ env.OS }} webtunnel-client
        if: always()
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=delete-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

  setup-alpine:
    needs:
      - generate-host-vars
      - select-webserver
    runs-on: self-hosted
    env:
      OS: alpine
      WEBSERVER_SOFTWARE: ${{ needs.select-webserver.outputs.webserver }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to S3
        uses: mc-actions/configure@v1
        with:
          s3_server: '${{ secrets.S3_ENDPOINT }}'
          s3_access_key: '${{ secrets.S3_ACCESS_KEY }}'
          s3_secret_key: '${{ secrets.S3_SECRET_KEY }}'

      - name: Download host_vars from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/test_host_vars/ host_vars/ >/dev/null && \
          echo "Downloaded test_host_vars successfully.

      - name: Download venv from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/venv/ venv/ >/dev/null && \
          echo "Downloaded venv successfully. Changing permissions now."
          chmod +x venv/bin/*

      - name: Delete ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }}
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=delete-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Create ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }} server
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=create-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Start all ${{ env.OS }} servers
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=start-server -i actions-inventory.ini -e 'os=${{ env.OS }}'


      - name: Wait until the ${{ env.OS }} servers are reachable
        run: |
          source venv/bin/activate
          python3 scripts/check_hosts.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Run Ansible Playbook Test for ${{ env.OS }}
        run: |
          source venv/bin/activate
          ansible-playbook playbook.yaml --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Upload connection-strings for ${{ env.OS }} to S3
        shell: bash
        run: |
          mc cp connection-strings.txt default/actions-artifacts/connection-strings-${{ env.OS }}

  test-alpine:
    needs: 
      - setup-alpine
    runs-on: self-hosted
    env:
      OS: alpine
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to S3
        uses: mc-actions/configure@v1
        with:
          s3_server: '${{ secrets.S3_ENDPOINT }}'
          s3_access_key: '${{ secrets.S3_ACCESS_KEY }}'
          s3_secret_key: '${{ secrets.S3_SECRET_KEY }}'

      - name: Download host_vars from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/test_host_vars/ host_vars/ >/dev/null && \
          echo "Downloaded test_host_vars successfully.

      - name: Download venv from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/venv/ venv/ >/dev/null && \
          echo "Downloaded venv successfully. Changing permissions now."
          chmod +x venv/bin/*

      - name: Create ${{ env.OS }} webtunnel-client
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=create-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

      - name: Download connection-strings-${{ env.OS }} from S3
        shell: bash
        run: |
          mc cp default/actions-artifacts/connection-strings-${{ env.OS }} connection-strings.txt

      - name: Wait until the ${{ env.OS }} webtunnel client is reacheable
        run: |
          source venv/bin/activate
          python3 scripts/check_hosts.py --limit ${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test connections
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=test-webtunnel --limit ${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test SSH connection
        run: |
          source venv/bin/activate
          python3 scripts/test_ssh.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Test HTTP/HTTPS connection
        run: |
          source venv/bin/activate
          python3 scripts/test_web.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Shutdown ${{ env.OS }} servers
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=shutdown-server -i actions-inventory.ini  -e "os=${{ env.OS }}"

      - name: Delete ${{ env.OS }} webtunnel-client
        if: always()
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=delete-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

  setup-archlinux:
    needs:
      - generate-host-vars
      - select-webserver
    runs-on: self-hosted
    env:
      OS: archlinux
      WEBSERVER_SOFTWARE: ${{ needs.select-webserver.outputs.webserver }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to S3
        uses: mc-actions/configure@v1
        with:
          s3_server: '${{ secrets.S3_ENDPOINT }}'
          s3_access_key: '${{ secrets.S3_ACCESS_KEY }}'
          s3_secret_key: '${{ secrets.S3_SECRET_KEY }}'

      - name: Download host_vars from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/test_host_vars/ host_vars/ >/dev/null && \
          echo "Downloaded test_host_vars successfully.

      - name: Download venv from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/venv/ venv/ >/dev/null && \
          echo "Downloaded venv successfully. Changing permissions now."
          chmod +x venv/bin/*

      - name: Delete ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }}
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=delete-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Create ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }} server
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=create-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Start all ${{ env.OS }} servers
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=start-server -i actions-inventory.ini -e 'os=${{ env.OS }}'


      - name: Wait until the ${{ env.OS }} servers are reachable
        run: |
          source venv/bin/activate
          python3 scripts/check_hosts.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Run Ansible Playbook Test for ${{ env.OS }}
        run: |
          source venv/bin/activate
          ansible-playbook playbook.yaml --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Upload connection-strings for ${{ env.OS }} to S3
        shell: bash
        run: |
          mc cp connection-strings.txt default/actions-artifacts/connection-strings-${{ env.OS }}

  test-archlinux:
    needs: 
      - setup-archlinux
    runs-on: self-hosted
    env:
      OS: archlinux
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to S3
        uses: mc-actions/configure@v1
        with:
          s3_server: '${{ secrets.S3_ENDPOINT }}'
          s3_access_key: '${{ secrets.S3_ACCESS_KEY }}'
          s3_secret_key: '${{ secrets.S3_SECRET_KEY }}'

      - name: Download host_vars from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/test_host_vars/ host_vars/ >/dev/null && \
          echo "Downloaded test_host_vars successfully.

      - name: Download venv from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/venv/ venv/ >/dev/null && \
          echo "Downloaded venv successfully. Changing permissions now."
          chmod +x venv/bin/*

      - name: Create ${{ env.OS }} webtunnel-client
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=create-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

      - name: Download connection-strings-${{ env.OS }} from S3
        shell: bash
        run: |
          mc cp default/actions-artifacts/connection-strings-${{ env.OS }} connection-strings.txt

      - name: Wait until the ${{ env.OS }} webtunnel client is reacheable
        run: |
          source venv/bin/activate
          python3 scripts/check_hosts.py --limit ${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test connections
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=test-webtunnel --limit ${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test SSH connection
        run: |
          source venv/bin/activate
          python3 scripts/test_ssh.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Test HTTP/HTTPS connection
        run: |
          source venv/bin/activate
          python3 scripts/test_web.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Shutdown ${{ env.OS }} servers
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=shutdown-server -i actions-inventory.ini  -e "os=${{ env.OS }}"

      - name: Delete ${{ env.OS }} webtunnel-client
        if: always()
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=delete-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

  setup-freebsd:
    needs:
      - generate-host-vars
      - select-webserver
    runs-on: self-hosted
    env:
      OS: freebsd
      WEBSERVER_SOFTWARE: ${{ needs.select-webserver.outputs.webserver }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to S3
        uses: mc-actions/configure@v1
        with:
          s3_server: '${{ secrets.S3_ENDPOINT }}'
          s3_access_key: '${{ secrets.S3_ACCESS_KEY }}'
          s3_secret_key: '${{ secrets.S3_SECRET_KEY }}'

      - name: Download host_vars from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/test_host_vars/ host_vars/ >/dev/null && \
          echo "Downloaded test_host_vars successfully.

      - name: Download venv from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/venv/ venv/ >/dev/null && \
          echo "Downloaded venv successfully. Changing permissions now."
          chmod +x venv/bin/*

      - name: Delete ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }}
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=delete-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Create ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }} server
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=create-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Start all ${{ env.OS }} servers
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=start-server -i actions-inventory.ini -e 'os=${{ env.OS }}'


      - name: Wait until the ${{ env.OS }} servers are reachable
        run: |
          source venv/bin/activate
          python3 scripts/check_hosts.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Run Ansible Playbook Test for ${{ env.OS }}
        run: |
          source venv/bin/activate
          ansible-playbook playbook.yaml --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Upload connection-strings for ${{ env.OS }} to S3
        shell: bash
        run: |
          mc cp connection-strings.txt default/actions-artifacts/connection-strings-${{ env.OS }}

  test-freebsd:
    needs: 
      - setup-freebsd
    runs-on: self-hosted
    env:
      OS: freebsd
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to S3
        uses: mc-actions/configure@v1
        with:
          s3_server: '${{ secrets.S3_ENDPOINT }}'
          s3_access_key: '${{ secrets.S3_ACCESS_KEY }}'
          s3_secret_key: '${{ secrets.S3_SECRET_KEY }}'

      - name: Download host_vars from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/test_host_vars/ host_vars/ >/dev/null && \
          echo "Downloaded test_host_vars successfully.

      - name: Download venv from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/venv/ venv/ >/dev/null && \
          echo "Downloaded venv successfully. Changing permissions now."
          chmod +x venv/bin/*

      - name: Create ${{ env.OS }} webtunnel-client
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=create-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

      - name: Download connection-strings-${{ env.OS }} from S3
        shell: bash
        run: |
          mc cp default/actions-artifacts/connection-strings-${{ env.OS }} connection-strings.txt

      - name: Wait until the ${{ env.OS }} webtunnel client is reacheable
        run: |
          source venv/bin/activate
          python3 scripts/check_hosts.py --limit ${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test connections
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=test-webtunnel --limit ${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test SSH connection
        run: |
          source venv/bin/activate
          python3 scripts/test_ssh.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Test HTTP/HTTPS connection
        run: |
          source venv/bin/activate
          python3 scripts/test_web.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Shutdown ${{ env.OS }} servers
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=shutdown-server -i actions-inventory.ini  -e "os=${{ env.OS }}"

      - name: Delete ${{ env.OS }} webtunnel-client
        if: always()
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=delete-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

  setup-openbsd:
    needs:
      - generate-host-vars
      - select-webserver
    runs-on: self-hosted
    env:
      OS: openbsd
      WEBSERVER_SOFTWARE: ${{ needs.select-webserver.outputs.webserver }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to S3
        uses: mc-actions/configure@v1
        with:
          s3_server: '${{ secrets.S3_ENDPOINT }}'
          s3_access_key: '${{ secrets.S3_ACCESS_KEY }}'
          s3_secret_key: '${{ secrets.S3_SECRET_KEY }}'

      - name: Download host_vars from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/test_host_vars/ host_vars/ >/dev/null && \
          echo "Downloaded test_host_vars successfully.

      - name: Download venv from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/venv/ venv/ >/dev/null && \
          echo "Downloaded venv successfully. Changing permissions now."
          chmod +x venv/bin/*

      - name: Delete ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }}
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=delete-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Create ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }} server
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=create-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Start all ${{ env.OS }} servers
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=start-server -i actions-inventory.ini -e 'os=${{ env.OS }}'


      - name: Wait until the ${{ env.OS }} servers are reachable
        run: |
          source venv/bin/activate
          python3 scripts/check_hosts.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Run Ansible Playbook Test for ${{ env.OS }}
        run: |
          source venv/bin/activate
          ansible-playbook playbook.yaml --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Upload connection-strings for ${{ env.OS }} to S3
        shell: bash
        run: |
          mc cp connection-strings.txt default/actions-artifacts/connection-strings-${{ env.OS }}

  test-openbsd:
    needs: 
      - setup-openbsd
    runs-on: self-hosted
    env:
      OS: openbsd
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to S3
        uses: mc-actions/configure@v1
        with:
          s3_server: '${{ secrets.S3_ENDPOINT }}'
          s3_access_key: '${{ secrets.S3_ACCESS_KEY }}'
          s3_secret_key: '${{ secrets.S3_SECRET_KEY }}'

      - name: Download host_vars from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/test_host_vars/ host_vars/ >/dev/null && \
          echo "Downloaded test_host_vars successfully.

      - name: Download venv from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/venv/ venv/ >/dev/null && \
          echo "Downloaded venv successfully. Changing permissions now."
          chmod +x venv/bin/*

      - name: Create ${{ env.OS }} webtunnel-client
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=create-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

      - name: Download connection-strings-${{ env.OS }} from S3
        shell: bash
        run: |
          mc cp default/actions-artifacts/connection-strings-${{ env.OS }} connection-strings.txt

      - name: Wait until the ${{ env.OS }} webtunnel client is reacheable
        run: |
          source venv/bin/activate
          python3 scripts/check_hosts.py --limit ${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test connections
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=test-webtunnel --limit ${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test SSH connection
        run: |
          source venv/bin/activate
          python3 scripts/test_ssh.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Test HTTP/HTTPS connection
        run: |
          source venv/bin/activate
          python3 scripts/test_web.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Shutdown ${{ env.OS }} servers
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=shutdown-server -i actions-inventory.ini  -e "os=${{ env.OS }}"

      - name: Delete ${{ env.OS }} webtunnel-client
        if: always()
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=delete-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

  setup-rhel:
    needs:
      - generate-host-vars
      - select-webserver
    runs-on: self-hosted
    env:
      OS: rhel
      WEBSERVER_SOFTWARE: ${{ needs.select-webserver.outputs.webserver }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to S3
        uses: mc-actions/configure@v1
        with:
          s3_server: '${{ secrets.S3_ENDPOINT }}'
          s3_access_key: '${{ secrets.S3_ACCESS_KEY }}'
          s3_secret_key: '${{ secrets.S3_SECRET_KEY }}'

      - name: Download host_vars from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/test_host_vars/ host_vars/ >/dev/null && \
          echo "Downloaded test_host_vars successfully.

      - name: Download venv from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/venv/ venv/ >/dev/null && \
          echo "Downloaded venv successfully. Changing permissions now."
          chmod +x venv/bin/*

      - name: Delete ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }}
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=delete-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Create ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }} server
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=create-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Start all ${{ env.OS }} servers
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=start-server -i actions-inventory.ini -e 'os=${{ env.OS }}'


      - name: Wait until the ${{ env.OS }} servers are reachable
        run: |
          source venv/bin/activate
          python3 scripts/check_hosts.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Run Ansible Playbook Test for ${{ env.OS }}
        run: |
          source venv/bin/activate
          ansible-playbook playbook.yaml --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Upload connection-strings for ${{ env.OS }} to S3
        shell: bash
        run: |
          mc cp connection-strings.txt default/actions-artifacts/connection-strings-${{ env.OS }}

  test-rhel:
    needs: 
      - setup-rhel
    runs-on: self-hosted
    env:
      OS: rhel
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to S3
        uses: mc-actions/configure@v1
        with:
          s3_server: '${{ secrets.S3_ENDPOINT }}'
          s3_access_key: '${{ secrets.S3_ACCESS_KEY }}'
          s3_secret_key: '${{ secrets.S3_SECRET_KEY }}'

      - name: Download host_vars from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/test_host_vars/ host_vars/ >/dev/null && \
          echo "Downloaded test_host_vars successfully.

      - name: Download venv from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/venv/ venv/ >/dev/null && \
          echo "Downloaded venv successfully. Changing permissions now."
          chmod +x venv/bin/*

      - name: Create ${{ env.OS }} webtunnel-client
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=create-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

      - name: Download connection-strings-${{ env.OS }} from S3
        shell: bash
        run: |
          mc cp default/actions-artifacts/connection-strings-${{ env.OS }} connection-strings.txt

      - name: Wait until the ${{ env.OS }} webtunnel client is reacheable
        run: |
          source venv/bin/activate
          python3 scripts/check_hosts.py --limit ${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test connections
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=test-webtunnel --limit ${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test SSH connection
        run: |
          source venv/bin/activate
          python3 scripts/test_ssh.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Test HTTP/HTTPS connection
        run: |
          source venv/bin/activate
          python3 scripts/test_web.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Shutdown ${{ env.OS }} servers
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=shutdown-server -i actions-inventory.ini  -e "os=${{ env.OS }}"

      - name: Delete ${{ env.OS }} webtunnel-client
        if: always()
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=delete-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

  setup-suse:
    needs:
      - generate-host-vars
      - select-webserver
    runs-on: self-hosted
    env:
      OS: suse
      WEBSERVER_SOFTWARE: ${{ needs.select-webserver.outputs.webserver }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to S3
        uses: mc-actions/configure@v1
        with:
          s3_server: '${{ secrets.S3_ENDPOINT }}'
          s3_access_key: '${{ secrets.S3_ACCESS_KEY }}'
          s3_secret_key: '${{ secrets.S3_SECRET_KEY }}'

      - name: Download host_vars from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/test_host_vars/ host_vars/ >/dev/null && \
          echo "Downloaded test_host_vars successfully.

      - name: Download venv from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/venv/ venv/ >/dev/null && \
          echo "Downloaded venv successfully. Changing permissions now."
          chmod +x venv/bin/*

      - name: Delete ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }}
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=delete-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Create ${{ env.OS }}-${{ env.WEBSERVER_SOFTWARE }} server
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=create-server -i actions-inventory.ini -e 'os=${{ env.OS }} webserver_software=["${{ env.WEBSERVER_SOFTWARE }}"]'

      - name: Start all ${{ env.OS }} servers
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=start-server -i actions-inventory.ini -e 'os=${{ env.OS }}'


      - name: Wait until the ${{ env.OS }} servers are reachable
        run: |
          source venv/bin/activate
          python3 scripts/check_hosts.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Run Ansible Playbook Test for ${{ env.OS }}
        run: |
          source venv/bin/activate
          ansible-playbook playbook.yaml --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Upload connection-strings for ${{ env.OS }} to S3
        shell: bash
        run: |
          mc cp connection-strings.txt default/actions-artifacts/connection-strings-${{ env.OS }}

  test-suse:
    needs: 
      - setup-suse
    runs-on: self-hosted
    env:
      OS: suse
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Login to S3
        uses: mc-actions/configure@v1
        with:
          s3_server: '${{ secrets.S3_ENDPOINT }}'
          s3_access_key: '${{ secrets.S3_ACCESS_KEY }}'
          s3_secret_key: '${{ secrets.S3_SECRET_KEY }}'

      - name: Download host_vars from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/test_host_vars/ host_vars/ >/dev/null && \
          echo "Downloaded test_host_vars successfully.

      - name: Download venv from S3
        shell: bash
        run: |
          mc cp -r default/actions-artifacts/venv/ venv/ >/dev/null && \
          echo "Downloaded venv successfully. Changing permissions now."
          chmod +x venv/bin/*

      - name: Create ${{ env.OS }} webtunnel-client
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=create-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"

      - name: Download connection-strings-${{ env.OS }} from S3
        shell: bash
        run: |
          mc cp default/actions-artifacts/connection-strings-${{ env.OS }} connection-strings.txt

      - name: Wait until the ${{ env.OS }} webtunnel client is reacheable
        run: |
          source venv/bin/activate
          python3 scripts/check_hosts.py --limit ${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test connections
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=test-webtunnel --limit ${{ env.OS }}-webtunnel-client -i actions-inventory.ini

      - name: Test SSH connection
        run: |
          source venv/bin/activate
          python3 scripts/test_ssh.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Test HTTP/HTTPS connection
        run: |
          source venv/bin/activate
          python3 scripts/test_web.py --limit ${{ env.OS }} -i actions-inventory.ini

      - name: Shutdown ${{ env.OS }} servers
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=shutdown-server -i actions-inventory.ini  -e "os=${{ env.OS }}"

      - name: Delete ${{ env.OS }} webtunnel-client
        if: always()
        run: |
          source venv/bin/activate
          ansible-playbook actions-playbook.yaml --tags=delete-webtunnel-client -i actions-inventory.ini -e "os=${{ env.OS }}"
