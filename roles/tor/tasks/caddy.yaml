---

- name: Block for setting up caddy (OS-Family Debian)
  when: ansible_os_family == "Debian"
  block:
    - name: Add the Caddy repository key
      ansible.builtin.apt_key:
        url: https://dl.cloudsmith.io/public/caddy/stable/gpg.key
        state: present

    - name: Add the Caddy APT repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://dl.cloudsmith.io/public/caddy/stable/deb/ubuntu focal main"
        state: present
        filename: caddy-stable

- name: Block for OS-spcific tasks (FreeBSD)
  when: ansible_os_family == "FreeBSD"
  block:
    - name: Set caddy-users
      community.general.sysrc:
        name: caddy_user
        value: "{{ caddy.user }}"
        state: value_present
      
    - name: Set caddy-group
      community.general.sysrc:
        name: caddy_group
        value: "{{ caddy.group }}"
        state: value_present

    - name: Install OS-specific software
      ansible.builtin.package:
        name:
          - portacl-rc
        state: present

    - name: Set portacl-user
      community.general.sysrc:
        name: portacl_users
        value: "{{ caddy.group }}"
        state: value_present

    - name: Set portacl-user privilege (tcp)
      community.general.sysrc:
        name: portacl_user_www_tcp
        value: http https
        state: value_present
      notify: Restart portacl

    - name: Set portacl-user privilege (udp)
      community.general.sysrc:
        name: portacl_user_www_udp
        value: https
        state: value_present
      notify: Restart portacl

    - name: Change ownership of caddy directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ caddy.user }}"
        group: "{{ caddy.group }}"
        recurse: true
      loop:
        - /var/db/caddy
        - /var/log/caddy
        - /var/run/caddy

- name: Block for OS-spcific tasks (RedHat)
  when: ansible_os_family == "RedHat"
  block:
    - name: Enable the Caddy COPR repository
      ansible.builtin.shell:
        cmd: dnf copr enable @caddy/caddy -y

- name: Block for all OS-Families
  block:
    - name: Install caddy
      ansible.builtin.package:
        name: 
          - caddy

    - name: Generate Caddyfile
      ansible.builtin.template:
        src: "{{ role_path }}/templates/Caddyfile.j2"
        dest: "{{ system.etc }}/caddy/Caddyfile"
        owner: "{{ root.user }}"
        group: "{{ root.group }}"
      notify: Restart caddy
      vars:
        webtunnel_path: "{{ lookup('file', role_path + '/files/' + inventory_hostname + '.txt') }}"