---

- name: Block for setting up caddy
  tags:
    - caddy
  block:

    - name: Add the Caddy repository key
      ansible.builtin.apt_key:
        url: https://dl.cloudsmith.io/public/caddy/stable/gpg.key
        state: present

    - name: Add the Caddy APT repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://dl.cloudsmith.io/public/caddy/stable/deb/ubuntu focal main"
        state: present
        filename: caddy-stable

    - name: Update APT cache
      ansible.builtin.apt:
        name: caddy
        update_cache: yes

    - name: Generate random string with 24 characters
      ansible.builtin.shell: echo $(cat /dev/urandom | tr -cd "qwertyuiopasdfghjklzxcvbnmMNBVCXZLKJHGFDSAQWERTUIOP0987654321"|head -c 24)
      register: random_string

    - name: Check if random string exists
      ansible.builtin.stat:
        path: "{{ role_path }}/files/{{ inventory_hostname }}.txt"
      register: random_string_file
      delegate_to: localhost

    - name: Create files with the random strings
      ansible.builtin.lineinfile:
        path: "{{ role_path }}/files/{{ inventory_hostname }}.txt"
        line: "{{ random_string.stdout }}"
        create: yes
      delegate_to: localhost
      when: not random_string_file.stat.exists

    - name: Generate Caddyfile
      ansible.builtin.template:
        src: "{{ role_path }}/templates/Caddyfile.j2"
        dest: /etc/caddy/Caddyfile
        owner: root
        group: root
      notify: Restart caddy
      vars:
        webtunnel_path: "{{ lookup('file', role_path + '/files/' + inventory_hostname + '.txt') }}"